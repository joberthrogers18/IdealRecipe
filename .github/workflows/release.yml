name: Validar PR e Criar Release

on:
  pull_request:
    types: [opened, edited, synchronize]
  push:
    branches:
      - main

jobs:
  validar-titulo-pr:
    name: Validar tÃ­tulo do PR
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Verificar formato do tÃ­tulo
        run: |
          if [[ ! "${{ github.event.pull_request.title }}" =~ ^.*v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "âŒ O tÃ­tulo do PR deve conter a versÃ£o no formato vX.Y.Z para tÃ­tulos de PRs refericiados para branch main."
            exit 1
          fi
          echo "âœ… TÃ­tulo vÃ¡lido!"

  criar-release:
    name: Criar Release AutomÃ¡tica
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checar cÃ³digo
        uses: actions/checkout@v4

      - name: Extrair versÃ£o do Ãºltimo commit/merge
        id: get_version
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Ãšltimo commit: $COMMIT_MSG"
          VERSION=$(echo "$COMMIT_MSG" | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+")
          if [ -z "$VERSION" ]; then
            echo "âŒ NÃ£o foi possÃ­vel encontrar uma versÃ£o no Ãºltimo commit."
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… VersÃ£o encontrada: $VERSION"

      - name: Executar Release Please
        uses: googleapis/release-please-action@v4
        with:
          release-type: simple
          package-name: meu-projeto
          version: ${{ steps.get_version.outputs.version }}
          bump-minor-pre-major: true
          changelog-types: |
            [
              {"type":"feat","section":"âœ¨ Novas Funcionalidades","hidden":false},
              {"type":"fix","section":"ğŸ› CorreÃ§Ãµes de Bugs","hidden":false},
              {"type":"docs","section":"ğŸ“š DocumentaÃ§Ã£o","hidden":false},
              {"type":"chore","section":"ğŸ§¹ ManutenÃ§Ã£o","hidden":true}
            ]
